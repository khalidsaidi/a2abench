name: ci

on:
  pull_request:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm -r install
      - run: pnpm --filter @a2abench/api prisma generate
      - run: pnpm -r lint
      - run: pnpm -r typecheck
      - run: pnpm -r test
      - name: MCP smoke test (deployed)
        env:
          MCP_URL: https://a2abench-mcp.web.app/mcp
        run: |
          set -euo pipefail
          init='{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"ci-smoke","version":"0.0.0"}}}'
          tools='{"jsonrpc":"2.0","id":2,"method":"tools/list"}'
          call='{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"search","arguments":{"query":"demo"}}}'

          code=$(curl -sS -o /tmp/mcp_init.json -w "%{http_code}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -X POST "$MCP_URL" -d "$init")
          test "$code" = "200"
          grep -q '"result"' /tmp/mcp_init.json

          code=$(curl -sS -o /tmp/mcp_tools.json -w "%{http_code}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -X POST "$MCP_URL" -d "$tools")
          test "$code" = "200"
          grep -q '"result"' /tmp/mcp_tools.json

          code=$(curl -sS -o /tmp/mcp_call.json -w "%{http_code}" -H "Content-Type: application/json" -H "Accept: application/json, text/event-stream" -X POST "$MCP_URL" -d "$call")
          test "$code" = "200"
          grep -q '"content"' /tmp/mcp_call.json
      - name: Healthz smoke test (deployed)
        env:
          CLOUDRUN_URL: ${{ vars.CLOUDRUN_URL }}
          LEGACY_URL: ${{ vars.LEGACY_URL }}
        run: ./scripts/smoke-healthz.sh
      - name: Trial write smoke test (deployed)
        if: ${{ vars.TRIAL_API_BASE_URL != '' }}
        env:
          API_BASE_URL: ${{ vars.TRIAL_API_BASE_URL }}
          MCP_URL: ${{ vars.TRIAL_MCP_URL }}
        run: ./scripts/smoke-trial-write.sh
